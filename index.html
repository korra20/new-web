<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        const qrContainer = document.getElementById('qrcode');
        let currentImageSrc = "https://via.placeholder.com/150"; 

        // --- 1. KOMPRESIA A NAČÍTANIE FOTKY ---
        document.getElementById('input-file').addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    
                    img.onload = function() {
                        // Vytvoríme "neviditeľné plátno" na zmenšenie fotky
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Nastavíme maximálnu veľkosť (napr. 300px)
                        const MAX_WIDTH = 300;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;

                        // Nakreslíme zmenšený obrázok na plátno
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        // Skonvertujeme na úsporný JPEG (kvalita 0.7)
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);

                        // Uložíme a zobrazíme
                        currentImageSrc = compressedDataUrl;
                        document.getElementById('display-img').src = currentImageSrc;
                    }
                }
                reader.readAsDataURL(file);
            }
        });

        // --- 2. START APLIKÁCIE ---
        window.onload = function() {
            try {
                const savedData = localStorage.getItem('myBizCard_V3_Fixed'); // Zmena kľúča pre istotu
                if (savedData) {
                    const data = JSON.parse(savedData);
                    updateUI(data);
                    fillInputs(data);
                    document.documentElement.style.setProperty('--primary', data.color);
                    if (data.image) {
                        currentImageSrc = data.image;
                        document.getElementById('display-img').src = currentImageSrc;
                    }
                } else {
                    // Prvé spustenie
                    initDefault();
                }
            } catch (e) {
                console.error("Chyba pri načítaní:", e);
                initDefault();
            }
        };

        function initDefault() {
            generateQR({
                name: "Vaše Meno",
                job: "Pozícia",
                phone: "",
                email: "",
                color: "#6366f1"
            });
        }

        // --- 3. GENERATOR QR ---
        function generateQR(data) {
            qrContainer.innerHTML = "";
            const vCardData = `BEGIN:VCARD
VERSION:3.0
N;CHARSET=UTF-8:${data.name};;;;
FN;CHARSET=UTF-8:${data.name}
ORG;CHARSET=UTF-8:${data.job}
TEL;TYPE=CELL:${data.phone}
EMAIL:${data.email}
END:VCARD`;

            new QRCode(qrContainer, {
                text: vCardData,
                width: 180,
                height: 180,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.L // Znížená korekcia pre ľahšie načítanie
            });
        }

        // --- 4. ULOŽENIE ---
        function saveData() {
            const data = {
                name: document.getElementById('input-name').value || "Bez mena",
                job: document.getElementById('input-job').value,
                phone: document.getElementById('input-phone').value,
                email: document.getElementById('input-email').value,
                color: document.getElementById('input-color').value,
                image: currentImageSrc
            };

            try {
                // Používam nový kľúč 'V3', aby sa to nebilo so starými chybami
                localStorage.setItem('myBizCard_V3_Fixed', JSON.stringify(data));
                updateUI(data);
                alert("Uložené! Fotka bola automaticky zmenšená.");
                document.getElementById('editor-view').style.display = 'none';
            } catch (e) {
                alert("Pamäť je plná! Skúste vymazať históriu prehliadača alebo reštartovať stránku.");
                console.error(e);
            }
        }

        function updateUI(data) {
            document.getElementById('display-name').innerText = data.name;
            document.getElementById('display-job').innerText = data.job;
            generateQR(data);
        }

        function fillInputs(data) {
            document.getElementById('input-name').value = data.name;
            document.getElementById('input-job').value = data.job;
            document.getElementById('input-phone').value = data.phone;
            document.getElementById('input-email').value = data.email;
            document.getElementById('input-color').value = data.color;
        }

        function previewTheme() {
            const color = document.getElementById('input-color').value;
            document.documentElement.style.setProperty('--primary', color);
        }

        function toggleEditor() {
            const editor = document.getElementById('editor-view');
            if (editor.style.display === 'none' || editor.style.display === '') {
                const password = prompt("Heslo (admin123):");
                if (password === "admin123") {
                    editor.style.display = 'block';
                    editor.scrollIntoView({behavior: "smooth"});
                } else {
                    alert("Zlé heslo.");
                }
            } else {
                editor.style.display = 'none';
            }
        }
    </script>